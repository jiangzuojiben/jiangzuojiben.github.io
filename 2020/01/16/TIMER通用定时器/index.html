<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>TIMER通用定时器 | jiangzuojiben</title><meta name="description" content="TIMER通用定时器"><meta name="keywords" content="stm32"><meta name="author" content="jiangzuojiben"><meta name="copyright" content="jiangzuojiben"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://jiangzuojiben.github.io/2020/01/16/TIMER%E9%80%9A%E7%94%A8%E5%AE%9A%E6%97%B6%E5%99%A8/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="TIMER通用定时器"><meta name="twitter:description" content="TIMER通用定时器"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><meta property="og:type" content="article"><meta property="og:title" content="TIMER通用定时器"><meta property="og:url" content="http://jiangzuojiben.github.io/2020/01/16/TIMER%E9%80%9A%E7%94%A8%E5%AE%9A%E6%97%B6%E5%99%A8/"><meta property="og:site_name" content="jiangzuojiben"><meta property="og:description" content="TIMER通用定时器"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="小明的死" href="http://jiangzuojiben.github.io/2020/08/02/%E5%B0%8F%E6%98%8E%E7%9A%84%E6%AD%BB/"><link rel="next" title="EXTI外部中断和看门狗实验" href="http://jiangzuojiben.github.io/2019/11/17/EXTI%E5%A4%96%E9%83%A8%E4%B8%AD%E6%96%AD%E5%92%8C%E7%9C%8B%E9%97%A8%E7%8B%97%E5%AE%9E%E9%AA%8C/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"cookieDomain":"https://jiangzuojiben.github.io/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  highlight_lang: 'true',
  highlight_shrink: 'false',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  copyright: {"languages":{"author":"作者: jiangzuojiben","link":"链接: http://jiangzuojiben.github.io/2020/01/16/TIMER%E9%80%9A%E7%94%A8%E5%AE%9A%E6%97%B6%E5%99%A8/","source":"来源: jiangzuojiben","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  copy_copyright_js: true
  
}</script><meta name="generator" content="Hexo 4.2.1"></head><body><canvas class="fireworks"></canvas><div id="header"> <div id="page-header"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">jiangzuojiben</a></span><i class="fa fa-bars fa-fw toggle-menu pull-right close" aria-hidden="true"></i><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right" id="search_button"></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lozad avatar_img" src="https://static.zerochan.net/Shinonome.Hakase.full.550228.jpg" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">13</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">7</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">3</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#通用定时器基本原理"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">通用定时器基本原理</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#三种STM32定时器区别"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">三种STM32定时器区别</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#通用定时器功能特点描述"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">通用定时器功能特点描述</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#计数器模式"><span class="toc_mobile_items-number">1.3.</span> <span class="toc_mobile_items-text">计数器模式</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#通用定时器-TIM2-3-4-5-工作过程"><span class="toc_mobile_items-number">1.4.</span> <span class="toc_mobile_items-text">通用定时器(TIM2,3,4,5)工作过程</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#定时器中断原理与配置"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">定时器中断原理与配置</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#时钟选择"><span class="toc_mobile_items-number">2.1.</span> <span class="toc_mobile_items-text">时钟选择</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#定时器中断实验相关寄存器"><span class="toc_mobile_items-number">2.2.</span> <span class="toc_mobile_items-text">定时器中断实验相关寄存器</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#定时器时基部分常用函数"><span class="toc_mobile_items-number">2.3.</span> <span class="toc_mobile_items-text">定时器时基部分常用函数</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#定时器中断实现步骤"><span class="toc_mobile_items-number">2.4.</span> <span class="toc_mobile_items-text">定时器中断实现步骤</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#程序源码"><span class="toc_mobile_items-number">2.5.</span> <span class="toc_mobile_items-text">程序源码</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#PWM输出原理与配置"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">PWM输出原理与配置</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#STM32-PWM工作过程"><span class="toc_mobile_items-number">3.1.</span> <span class="toc_mobile_items-text">STM32 PWM工作过程</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#定时器PWM功能常用函数"><span class="toc_mobile_items-number">3.2.</span> <span class="toc_mobile_items-text">定时器PWM功能常用函数</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#PWM输出配置步骤："><span class="toc_mobile_items-number">3.3.</span> <span class="toc_mobile_items-text">PWM输出配置步骤：</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#程序源码-1"><span class="toc_mobile_items-number">3.4.</span> <span class="toc_mobile_items-text">程序源码</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#输入捕获原理与配置"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">输入捕获原理与配置</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#STM32-输入捕获工作过程"><span class="toc_mobile_items-number">4.1.</span> <span class="toc_mobile_items-text">STM32 输入捕获工作过程</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#定时器输入捕获功能常用函数"><span class="toc_mobile_items-number">4.2.</span> <span class="toc_mobile_items-text">定时器输入捕获功能常用函数</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#输入捕获的一般配置关键步骤"><span class="toc_mobile_items-number">4.3.</span> <span class="toc_mobile_items-text">输入捕获的一般配置关键步骤</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#程序源码-2"><span class="toc_mobile_items-number">4.4.</span> <span class="toc_mobile_items-text">程序源码</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#TIMER电容触摸按键原理与实验"><span class="toc_mobile_items-number">5.</span> <span class="toc_mobile_items-text">TIMER电容触摸按键原理与实验</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#电容触摸按键原理"><span class="toc_mobile_items-number">5.1.</span> <span class="toc_mobile_items-text">电容触摸按键原理</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#几个重要的函数"><span class="toc_mobile_items-number">5.2.</span> <span class="toc_mobile_items-text">几个重要的函数</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#程序源码-3"><span class="toc_mobile_items-number">5.3.</span> <span class="toc_mobile_items-text">程序源码</span></a></li></ol></li></ol></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#通用定时器基本原理"><span class="toc-number">1.</span> <span class="toc-text">通用定时器基本原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#三种STM32定时器区别"><span class="toc-number">1.1.</span> <span class="toc-text">三种STM32定时器区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通用定时器功能特点描述"><span class="toc-number">1.2.</span> <span class="toc-text">通用定时器功能特点描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#计数器模式"><span class="toc-number">1.3.</span> <span class="toc-text">计数器模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通用定时器-TIM2-3-4-5-工作过程"><span class="toc-number">1.4.</span> <span class="toc-text">通用定时器(TIM2,3,4,5)工作过程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#定时器中断原理与配置"><span class="toc-number">2.</span> <span class="toc-text">定时器中断原理与配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#时钟选择"><span class="toc-number">2.1.</span> <span class="toc-text">时钟选择</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#定时器中断实验相关寄存器"><span class="toc-number">2.2.</span> <span class="toc-text">定时器中断实验相关寄存器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#定时器时基部分常用函数"><span class="toc-number">2.3.</span> <span class="toc-text">定时器时基部分常用函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#定时器中断实现步骤"><span class="toc-number">2.4.</span> <span class="toc-text">定时器中断实现步骤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#程序源码"><span class="toc-number">2.5.</span> <span class="toc-text">程序源码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PWM输出原理与配置"><span class="toc-number">3.</span> <span class="toc-text">PWM输出原理与配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#STM32-PWM工作过程"><span class="toc-number">3.1.</span> <span class="toc-text">STM32 PWM工作过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#定时器PWM功能常用函数"><span class="toc-number">3.2.</span> <span class="toc-text">定时器PWM功能常用函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PWM输出配置步骤："><span class="toc-number">3.3.</span> <span class="toc-text">PWM输出配置步骤：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#程序源码-1"><span class="toc-number">3.4.</span> <span class="toc-text">程序源码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#输入捕获原理与配置"><span class="toc-number">4.</span> <span class="toc-text">输入捕获原理与配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#STM32-输入捕获工作过程"><span class="toc-number">4.1.</span> <span class="toc-text">STM32 输入捕获工作过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#定时器输入捕获功能常用函数"><span class="toc-number">4.2.</span> <span class="toc-text">定时器输入捕获功能常用函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#输入捕获的一般配置关键步骤"><span class="toc-number">4.3.</span> <span class="toc-text">输入捕获的一般配置关键步骤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#程序源码-2"><span class="toc-number">4.4.</span> <span class="toc-text">程序源码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TIMER电容触摸按键原理与实验"><span class="toc-number">5.</span> <span class="toc-text">TIMER电容触摸按键原理与实验</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#电容触摸按键原理"><span class="toc-number">5.1.</span> <span class="toc-text">电容触摸按键原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#几个重要的函数"><span class="toc-number">5.2.</span> <span class="toc-text">几个重要的函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#程序源码-3"><span class="toc-number">5.3.</span> <span class="toc-text">程序源码</span></a></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png)"><div id="post-info"><div id="post-title"><div class="posttitle">TIMER通用定时器</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-01-16<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-01-16</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/STM32F429/">STM32F429</a></span><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">4.8k</span><span class="post-meta__separator">|</span><span>阅读时长: 17 分钟</span><span class="post-meta__separator">|</span><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head></head><body><h1 id="通用定时器基本原理"><a href="#通用定时器基本原理" class="headerlink" title="通用定时器基本原理"></a>通用定时器基本原理</h1><h2 id="三种STM32定时器区别"><a href="#三种STM32定时器区别" class="headerlink" title="三种STM32定时器区别"></a>三种STM32定时器区别</h2><table>
<thead>
<tr>
<th>定时器  种类</th>
<th>位数</th>
<th>计数器 模式</th>
<th>产生DMA请求</th>
<th>捕获比较  通道</th>
<th>互补   输出</th>
<th>特殊应用场景</th>
</tr>
</thead>
<tbody><tr>
<td>高级定时器  （TIM1,TIM8)</td>
<td>16</td>
<td>向上，向下，向上/下</td>
<td>可以</td>
<td>4</td>
<td>有</td>
<td>带可编程死区的互补输出</td>
</tr>
<tr>
<td>通用定时器（TIM2,TIM5）</td>
<td>32</td>
<td>向上，向下，向上/下</td>
<td>可以</td>
<td>4</td>
<td>无</td>
<td>通用。定时计数，PWM输出，输入捕获，输出比较</td>
</tr>
<tr>
<td>通用定时器（TIM3,TIM4）</td>
<td>16</td>
<td>向上，向下，向上/下</td>
<td>可以</td>
<td>4</td>
<td>无</td>
<td>通用。定时计数，PWM输出，输入捕获，输出比较</td>
</tr>
<tr>
<td>通用定时器（TIM9~TIM14）</td>
<td>16</td>
<td>向上</td>
<td>没有</td>
<td>2</td>
<td>无</td>
<td>通用。定时计数，PWM输出，输入捕获，输出比较</td>
</tr>
<tr>
<td>基本定时器  (TIM6,TIM7)</td>
<td>16</td>
<td>向上，向下，向上/下</td>
<td>可以</td>
<td>0</td>
<td>无</td>
<td>主要应用于驱动DAC</td>
</tr>
</tbody></table>
<h2 id="通用定时器功能特点描述"><a href="#通用定时器功能特点描述" class="headerlink" title="通用定时器功能特点描述"></a>通用定时器功能特点描述</h2><ul>
<li><p>STM32的通用 TIMx (TIM2、TIM3、TIM4 和 TIM5等)定时器功能特点包括：</p>
</li>
<li><p>16 /32 位向上、向下、向上/向下(中心对齐)计数模式，自动装载计数器（TIMx_CNT）。</p>
</li>
<li><p>16 位可编程(可以实时修改)预分频器(TIMx_PSC)，计数器时钟频率的分频系数 为 1～65535 之间的任意数值。</p>
</li>
<li><p>4 个独立通道（TIMx_CH1~4），这些通道可以用来作为： </p>
<p>① 输入捕获 </p>
<p>② 输出比较</p>
<p>③ PWM 生成(边缘或中间对齐模式) </p>
<p>④ 单脉冲模式输出 </p>
</li>
<li><p>可使用外部信号（TIMx_ETR）控制定时器和定时器互连（可以用 1 个定时器控制另外一个定时器）的同步电路。</p>
</li>
<li><p>如下事件发生时产生中断/DMA（6个独立的IRQ/DMA请求生成器）： </p>
<p>①更新：计数器向上溢出/向下溢出，计数器初始化(通过软件或者内部/外部触发) </p>
<p>②触发事件(计数器启动、停止、初始化或者由内部/外部触发计数) </p>
<p>③输入捕获 </p>
<p>④输出比较 </p>
<p>⑤支持针对定位的增量(正交)编码器和霍尔传感器电路 </p>
<p>⑥触发输入作为外部时钟或者按周期的电流管理</p>
</li>
<li><p>STM32 的通用定时器可以被用于：测量输入信号的脉冲长度(输入捕获)或者产生输出波形(输出比较和 PWM)等。  </p>
</li>
<li><p>使用定时器预分频器和 RCC 时钟控制器预分频器，脉冲长度和波形周期可以在几个微秒到几个毫秒间调整。STM32 的每个通用定时器都是完全独立的，没有互相共享的任何资源。</p>
</li>
</ul>
<h2 id="计数器模式"><a href="#计数器模式" class="headerlink" title="计数器模式"></a>计数器模式</h2><p><strong>通用定时器可以向上计数、向下计数、向上向下双向计数模式</strong>。</p>
<p>①向上计数模式：计数器从0计数到自动加载值(TIMx_ARR)，然后重新从0开始计数并且产生一个计数器溢出事件。</p>
<p>②向下计数模式：计数器从自动装入的值(TIMx_ARR)开始向下计数到0，然后从自动装入的值重新开始，并产生一个计数器向下溢出事件。</p>
<p>③中央对齐模式（向上/向下计数）：计数器从0开始计数到自动装入的值-1，产生一个计数器溢出事件，然后向下计数到1并且产生一个计数器溢出事件；然后再从0开始重新计数。</p>
<h2 id="通用定时器-TIM2-3-4-5-工作过程"><a href="#通用定时器-TIM2-3-4-5-工作过程" class="headerlink" title="通用定时器(TIM2,3,4,5)工作过程"></a>通用定时器(TIM2,3,4,5)工作过程</h2><p><img alt="通用定时器工作过程" data-src="https://s2.ax1x.com/2020/01/16/lvvtMQ.md.png" class="lozad"></p>
<h1 id="定时器中断原理与配置"><a href="#定时器中断原理与配置" class="headerlink" title="定时器中断原理与配置"></a>定时器中断原理与配置</h1><h2 id="时钟选择"><a href="#时钟选择" class="headerlink" title="时钟选择"></a>时钟选择</h2><p>计数器时钟可以由下列时钟源提供：</p>
<p>①<strong>内部时钟(CK_INT)</strong></p>
<p><strong>除非APB1的分频系数是1，否则通用定时器的时钟CK_INT等于APB1时钟的2倍。</strong></p>
<p><img alt="内部时钟选择" data-src="https://s2.ax1x.com/2020/01/16/lvvGRS.png" class="lozad"></p>
<p>②外部时钟模式1：外部输入脚(TIx)</p>
<p>③外部时钟模式2：外部触发输入(ETR)(仅适用TIM2,3,4)</p>
<p>④内部触发输入(ITRx)：使用一个定时器作为另一个定时器的预分频器，如可以配置一个定时器Timer1而作为另一个定时器Timer2的预分频器。</p>
<h2 id="定时器中断实验相关寄存器"><a href="#定时器中断实验相关寄存器" class="headerlink" title="定时器中断实验相关寄存器"></a>定时器中断实验相关寄存器</h2><p><strong>计数器当前值寄存器CNT</strong></p>
<p><img alt="计数器当前值寄存器CNT" data-src="https://s2.ax1x.com/2020/01/16/lvv3Pf.md.png" class="lozad"></p>
<p><strong>预分频寄存器TIMx_PSC</strong></p>
<p><img alt="预分频寄存器TIMx_PSC" data-src="https://s2.ax1x.com/2020/01/16/lvvNrj.md.png" class="lozad"></p>
<p><strong>自动重装载寄存器（TIMx_ARR)</strong></p>
<p><img alt="自动重装载寄存器（TIMx_ARR)" data-src="https://s2.ax1x.com/2020/01/16/lvvUqs.md.png" class="lozad"></p>
<p><strong>控制寄存器1（TIMx_CR1）</strong></p>
<p><img alt="控制寄存器1（TIMx_CR1）" data-src="https://s2.ax1x.com/2020/01/16/lvv8G8.md.png" class="lozad"></p>
<p><strong>DMA中断使能寄存器（TIMx_DIER）</strong></p>
<p><img alt="DMA中断使能寄存器（TIMx_DIER）" data-src="https://s2.ax1x.com/2020/01/16/lvv9bR.md.png" class="lozad"></p>
<h2 id="定时器时基部分常用函数"><a href="#定时器时基部分常用函数" class="headerlink" title="定时器时基部分常用函数"></a><strong>定时器时基部分常用函数</strong></h2><p><strong>①定时器时基参数初始化函数：</strong></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HAL_StatusTypeDef <span class="title">HAL_TIM_Base_Init</span><span class="params">(TIM_HandleTypeDef *htim)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="keyword">uint32_t</span> Prescaler;      <span class="comment">//预分频系数                           </span></span><br><span class="line">  <span class="keyword">uint32_t</span> CounterMode;   <span class="comment">//计数模式：向上/下                       </span></span><br><span class="line">  <span class="keyword">uint32_t</span> Period;     <span class="comment">//自动装载值                               </span></span><br><span class="line">  <span class="keyword">uint32_t</span> ClockDivision;  <span class="comment">//时钟分频因子：定时器时钟与数字滤波器分频比</span></span><br><span class="line">  <span class="keyword">uint32_t</span> RepetitionCounter; <span class="comment">//重复计数次数：高级定时器使用         </span></span><br><span class="line">} TIM_Base_InitTypeDef;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>②定时器时基参数初始化回调函数：</strong></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_Base_MspInit</span><span class="params">(TIM_HandleTypeDef *htim)</span></span>;</span><br><span class="line"><span class="comment">/*主要用来编写定时器时钟使能，以及中断优先级。*/</span></span><br><span class="line"></span><br><span class="line">__HAL_RCC_TIM3_CLK_ENABLE();<span class="comment">//定时器3时钟使能</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>③使能定时器：</strong></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HAL_StatusTypeDef <span class="title">HAL_TIM_Base_Start</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">HAL_StatusTypeDef <span class="title">HAL_TIM_Base_Start_IT</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br><span class="line"><span class="function"><span class="comment">//此函数同时开启了定时器更新中断</span></span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>④定时器中断通用处理函数：</strong></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_IRQHandler</span><span class="params">(TIM_HandleTypeDef *htim)</span></span>;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>该函数被中断服务函数调用。是定时器中断处理通用入口函数，</strong></p>
<p><strong>通过对中断类型进行分析判断，调用对应的回调函数。</strong></p>
<p><strong>⑤定时器中断处理回调函数：</strong></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_PeriodElapsedCallback</span><span class="params">(TIM_HandleTypeDef *htim)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_OC_DelayElapsedCallback</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_IC_CaptureCallback</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_PWM_PulseFinishedCallback</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_TriggerCallback</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_ErrorCallback</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="定时器中断实现步骤"><a href="#定时器中断实现步骤" class="headerlink" title="定时器中断实现步骤"></a>定时器中断实现步骤</h2><p>① 使能定时器时钟。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__HAL_RCC_TIM3_CLK_ENABLE();</span><br></pre></td></tr></tbody></table></figure>

<p>②  初始化定时器，配置ARR,PSC。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HAL_TIM_Base_Init();</span><br></pre></td></tr></tbody></table></figure>

<p>③ 开启定时器/中断。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HAL_TIM_Base_Start();</span><br><span class="line"></span><br><span class="line">HAL_TIM_Base_Start_IT();</span><br></pre></td></tr></tbody></table></figure>

<p>④ 设置中断优先级。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HAL_NVIC_SetPriority();</span><br><span class="line">HAL_NVIC_EnableIRQ();</span><br></pre></td></tr></tbody></table></figure>

<p>⑤  编写中断服务函数。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TIMx_IRQHandler();<span class="comment">//中断服务函数</span></span><br><span class="line"></span><br><span class="line">HAL_TIM_IRQHandler();<span class="comment">//中断处理入口函数</span></span><br><span class="line"></span><br><span class="line">HAL_TIM_PeriodElapsedCallback();<span class="comment">//定时器更新中断回调函数</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="程序源码"><a href="#程序源码" class="headerlink" title="程序源码"></a>程序源码</h2><p>timer.c</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"timer.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"led.h"</span></span></span><br><span class="line"></span><br><span class="line">TIM_HandleTypeDef TIM3_Handler;      <span class="comment">//定时器句柄 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//通用定时器3中断初始化</span></span><br><span class="line"><span class="comment">//arr：自动重装值。</span></span><br><span class="line"><span class="comment">//psc：时钟预分频数</span></span><br><span class="line"><span class="comment">//定时器溢出时间计算方法:Tout=((arr+1)*(psc+1))/Ft us.</span></span><br><span class="line"><span class="comment">//Ft=定时器工作频率,单位:Mhz</span></span><br><span class="line"><span class="comment">//这里使用的是定时器3!(定时器3挂在APB1上，时钟为HCLK/2)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM3_Init</span><span class="params">(u16 arr,u16 psc)</span></span></span><br><span class="line"><span class="function"></span>{  </span><br><span class="line">    TIM3_Handler.Instance=TIM3;                          <span class="comment">//通用定时器3</span></span><br><span class="line">    TIM3_Handler.Init.Prescaler=psc;                     <span class="comment">//分频系数</span></span><br><span class="line">    TIM3_Handler.Init.CounterMode=TIM_COUNTERMODE_UP;    <span class="comment">//向上计数器</span></span><br><span class="line">    TIM3_Handler.Init.Period=arr;                        <span class="comment">//自动装载值</span></span><br><span class="line">    TIM3_Handler.Init.ClockDivision=TIM_CLOCKDIVISION_DIV1;<span class="comment">//时钟分频因子</span></span><br><span class="line">    HAL_TIM_Base_Init(&TIM3_Handler);</span><br><span class="line">    </span><br><span class="line">    HAL_TIM_Base_Start_IT(&TIM3_Handler); <span class="comment">//使能定时器3和定时器3更新中断：TIM_IT_UPDATE   </span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//定时器底册驱动，开启时钟，设置中断优先级</span></span><br><span class="line"><span class="comment">//此函数会被HAL_TIM_Base_Init()函数调用</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_Base_MspInit</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span>(htim->Instance==TIM3)</span><br><span class="line">	{</span><br><span class="line">		__HAL_RCC_TIM3_CLK_ENABLE();            <span class="comment">//使能TIM3时钟</span></span><br><span class="line">		HAL_NVIC_SetPriority(TIM3_IRQn,<span class="number">1</span>,<span class="number">3</span>);    <span class="comment">//设置中断优先级，抢占优先级1，子优先级3</span></span><br><span class="line">		HAL_NVIC_EnableIRQ(TIM3_IRQn);          <span class="comment">//开启ITM3中断   </span></span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//定时器3中断服务函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM3_IRQHandler</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    HAL_TIM_IRQHandler(&TIM3_Handler);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//回调函数，定时器中断服务函数调用</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_PeriodElapsedCallback</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span>(htim==(&TIM3_Handler))</span><br><span class="line">    {</span><br><span class="line">        LED1=!LED1;        <span class="comment">//LED1反转</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h1 id="PWM输出原理与配置"><a href="#PWM输出原理与配置" class="headerlink" title="PWM输出原理与配置"></a>PWM输出原理与配置</h1><h2 id="STM32-PWM工作过程"><a href="#STM32-PWM工作过程" class="headerlink" title="STM32 PWM工作过程"></a>STM32 PWM工作过程</h2><p>PWM模式：脉冲宽度调制模式可以生成一个信号，该信号频率由TIMx_ARR寄存器决定，其占空比则由TIMx_CRRx寄存器决定。</p>
<p><img alt="PWM工作过程1" data-src="https://s2.ax1x.com/2020/01/16/lvjv2F.png" class="lozad"></p>
<p><img alt="PWM工作过程2" data-src="https://s2.ax1x.com/2020/01/16/lvjxv4.png" class="lozad"></p>
<p>CCR1:捕获比较(值)寄存器（x=1,2,3,4):设置比较值。</p>
<p>CCMR1: OC1M[2:0]位：</p>
<p>​               对于PWM方式下，用于设置PWM模式1【110】或者PWM模式2【111】</p>
<p><img alt="PWM模式" data-src="https://s2.ax1x.com/2020/01/16/lvvpr9.png" class="lozad"></p>
<p>CCER:CC1P位：输入/捕获1输出极性。0：高电平有效，1：低电平有效。</p>
<p>CCER:CC1E位：输入/捕获1输出使能。0：关闭，1：打开。</p>
<h2 id="定时器PWM功能常用函数"><a href="#定时器PWM功能常用函数" class="headerlink" title="定时器PWM功能常用函数"></a>定时器PWM功能常用函数</h2><p><strong>①定时器PWM时基参数初始化函数：</strong></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HAL_StatusTypeDef <span class="title">HAL_TIM_PWM_Init</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> struct</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">uint32_t</span> Prescaler;      <span class="comment">//预分频系数                              </span></span><br><span class="line">  <span class="keyword">uint32_t</span> CounterMode;   <span class="comment">//计数模式：向上/下                                </span></span><br><span class="line">  <span class="keyword">uint32_t</span> Period;     <span class="comment">//自动装载值                                                                   </span></span><br><span class="line">  <span class="keyword">uint32_t</span> ClockDivision;  <span class="comment">//时钟分频因子：定时器时钟与数字滤波器分频比</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">uint32_t</span> RepetitionCounter; <span class="comment">//重复计数次数：高级定时器使用                                                                    </span></span><br><span class="line">} TIM_Base_InitTypeDef;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>②定时器PWM时基参数初始化回调函数：</strong></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_PWM_MspInit</span><span class="params">(TIM_HandleTypeDef *htim)</span></span>;</span><br><span class="line"><span class="comment">/*主要用来编写定时器时钟使能等。*/</span></span><br><span class="line"></span><br><span class="line">__HAL_RCC_TIM3_CLK_ENABLE();<span class="comment">//定时器3时钟使能</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>③PWM输出比较通道参数配置函数：</strong></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HAL_StatusTypeDef <span class="title">HAL_TIM_PWM_ConfigChannel</span><span class="params">(TIM_HandleTypeDef *htim, TIM_OC_InitTypeDef* sConfig, <span class="keyword">uint32_t</span> channel)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="keyword">uint32_t</span> OCMode;     <span class="comment">//模式PMW1 OR PWM2                         </span></span><br><span class="line">  <span class="keyword">uint32_t</span> Pulse;      <span class="comment">//设置比较值</span></span><br><span class="line">  <span class="keyword">uint32_t</span> OCPolarity; <span class="comment">//输出比较极性 </span></span><br><span class="line">  <span class="keyword">uint32_t</span> OCNPolarity;   </span><br><span class="line">  <span class="keyword">uint32_t</span> OCFastMode;   </span><br><span class="line">  <span class="keyword">uint32_t</span> OCIdleState;                                          </span><br><span class="line">  <span class="keyword">uint32_t</span> OCNIdleState;                                         </span><br><span class="line">} TIM_OC_InitTypeDef;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>④使能定时器和PWM输出比较通道：</strong></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HAL_StatusTypeDef <span class="title">HAL_TIM_PWM_Start</span><span class="params">(TIM_HandleTypeDef *htim, <span class="keyword">uint32_t</span> Channel)</span></span>;</span><br><span class="line"><span class="function">HAL_StatusTypeDef <span class="title">HAL_TIM_PWM_Start_IT</span><span class="params">(TIM_HandleTypeDef *htim, <span class="keyword">uint32_t</span> Channel)</span></span>;<span class="comment">//此函数同时开启了定时器PWM通道的输出比较中断</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="PWM输出配置步骤："><a href="#PWM输出配置步骤：" class="headerlink" title="PWM输出配置步骤："></a>PWM输出配置步骤：</h2><p>①使能定时器时钟和通道IO口时钟。</p>
<p>②配置IO口复用映射：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HAL_GPIO_Init();</span><br></pre></td></tr></tbody></table></figure>

<p>③初始化PWM时基参数:</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HAL_TIM_PWM_Init();</span><br></pre></td></tr></tbody></table></figure>

<p>④初始化PWM通道参数：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HAL_TIM_PWM_ConfigChannel();</span><br></pre></td></tr></tbody></table></figure>

<p>⑤使能定时器PWM</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HAL_TIM_PWM_Start();</span><br></pre></td></tr></tbody></table></figure>

<h2 id="程序源码-1"><a href="#程序源码-1" class="headerlink" title="程序源码"></a>程序源码</h2><p>timer.c</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"timer.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"led.h"</span> </span></span><br><span class="line"></span><br><span class="line">TIM_HandleTypeDef TIM3_Handler;         <span class="comment">//定时器3PWM句柄 </span></span><br><span class="line">TIM_OC_InitTypeDef TIM3_CH4Handler;	    <span class="comment">//定时器3通道4句柄</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//TIM3 PWM部分初始化 </span></span><br><span class="line"><span class="comment">//PWM输出初始化</span></span><br><span class="line"><span class="comment">//arr：自动重装值</span></span><br><span class="line"><span class="comment">//psc：时钟预分频数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM3_PWM_Init</span><span class="params">(u16 arr,u16 psc)</span></span></span><br><span class="line"><span class="function"></span>{ </span><br><span class="line">    TIM3_Handler.Instance=TIM3;            <span class="comment">//定时器3</span></span><br><span class="line">    TIM3_Handler.Init.Prescaler=psc;       <span class="comment">//定时器分频</span></span><br><span class="line">    TIM3_Handler.Init.CounterMode=TIM_COUNTERMODE_UP;<span class="comment">//向上计数模式</span></span><br><span class="line">    TIM3_Handler.Init.Period=arr;          <span class="comment">//自动重装载值</span></span><br><span class="line">    TIM3_Handler.Init.ClockDivision=TIM_CLOCKDIVISION_DIV1;</span><br><span class="line">    HAL_TIM_PWM_Init(&TIM3_Handler);       <span class="comment">//初始化PWM</span></span><br><span class="line">    </span><br><span class="line">    TIM3_CH4Handler.OCMode=TIM_OCMODE_PWM1; <span class="comment">//模式选择PWM1</span></span><br><span class="line">    TIM3_CH4Handler.Pulse=arr/<span class="number">2</span>;            <span class="comment">//设置比较值,此值用来确定占空比，默认比较值为自动重装载值的一半,即占空比为50%</span></span><br><span class="line">    TIM3_CH4Handler.OCPolarity=TIM_OCPOLARITY_LOW; <span class="comment">//输出比较极性为低 </span></span><br><span class="line">    HAL_TIM_PWM_ConfigChannel(&TIM3_Handler,&TIM3_CH4Handler,TIM_CHANNEL_4);<span class="comment">//配置TIM3通道4</span></span><br><span class="line">	</span><br><span class="line">    HAL_TIM_PWM_Start(&TIM3_Handler,TIM_CHANNEL_4);<span class="comment">//开启PWM通道4</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//定时器底层驱动，时钟使能，引脚配置</span></span><br><span class="line"><span class="comment">//此函数会被HAL_TIM_PWM_Init()调用</span></span><br><span class="line"><span class="comment">//htim:定时器句柄</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_PWM_MspInit</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    GPIO_InitTypeDef GPIO_Initure;</span><br><span class="line">	__HAL_RCC_TIM3_CLK_ENABLE();			<span class="comment">//使能定时器3</span></span><br><span class="line">    __HAL_RCC_GPIOB_CLK_ENABLE();			<span class="comment">//开启GPIOB时钟</span></span><br><span class="line">	</span><br><span class="line">    GPIO_Initure.Pin=GPIO_PIN_1;           	<span class="comment">//PB1</span></span><br><span class="line">    GPIO_Initure.Mode=GPIO_MODE_AF_PP;  	<span class="comment">//复用推挽输出</span></span><br><span class="line">    GPIO_Initure.Pull=GPIO_PULLUP;          <span class="comment">//上拉</span></span><br><span class="line">    GPIO_Initure.Speed=GPIO_SPEED_HIGH;     <span class="comment">//高速</span></span><br><span class="line">	GPIO_Initure.Alternate= GPIO_AF2_TIM3;	<span class="comment">//PB1复用为TIM3_CH4</span></span><br><span class="line">    HAL_GPIO_Init(GPIOB,&GPIO_Initure);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//设置TIM通道4的占空比</span></span><br><span class="line"><span class="comment">//compare:比较值</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM_SetTIM3Compare4</span><span class="params">(u32 compare)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	TIM3->CCR4=compare; </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1 id="输入捕获原理与配置"><a href="#输入捕获原理与配置" class="headerlink" title="输入捕获原理与配置"></a>输入捕获原理与配置</h1><h2 id="STM32-输入捕获工作过程"><a href="#STM32-输入捕获工作过程" class="headerlink" title="STM32 输入捕获工作过程"></a>STM32 输入捕获工作过程</h2><p><img alt="STM32 输入捕获工作过程" data-src="https://s2.ax1x.com/2020/01/16/lvvSKJ.md.png" class="lozad"></p>
<p>通过检测TIMx_CHx上的边沿信号，在边沿信号发生跳变（比如上升沿/下降沿）的时候，将当前定时器的值(TIMx_CNT)存放到对应的捕获/比较寄存器（TIMx_CCRx)里面，完成一次捕获。</p>
<p><strong>步骤1：设置输入捕获滤波器</strong></p>
<p><img alt="设置输入捕获滤波器1" data-src="https://s2.ax1x.com/2020/01/16/lvvPV1.png" class="lozad"></p>
<p><img alt="设置输入捕获滤波器2" data-src="https://s2.ax1x.com/2020/01/16/lvviUx.md.png" class="lozad"></p>
<p><strong>步骤2：设置输入捕获极性</strong></p>
<p><img alt="设置输入捕获极性1" data-src="https://s2.ax1x.com/2020/01/16/lvvAPK.png" class="lozad"></p>
<p><img alt="设置输入捕获极性2" data-src="https://s2.ax1x.com/2020/01/16/lvvE8O.md.png" class="lozad"></p>
<p><strong>步骤三：设置输入捕获映射通道</strong></p>
<p><img alt="设置输入捕获映射通道1" data-src="https://s2.ax1x.com/2020/01/16/lvvV2D.png" class="lozad"></p>
<p><img alt="设置输入捕获映射通道2" data-src="https://s2.ax1x.com/2020/01/16/lvvZxe.md.png" class="lozad"></p>
<p><strong>步骤四：设置输入捕获分频器</strong></p>
<p><img alt="设置输入捕获分频器（通道1为例）1" data-src="https://s2.ax1x.com/2020/01/16/lvvmKH.png" class="lozad"></p>
<p><img alt="设置输入捕获分频器（通道1为例）2" data-src="https://s2.ax1x.com/2020/01/16/lvvnrd.png" class="lozad"></p>
<p><img alt="设置输入捕获分频器（通道1为例）3" data-src="https://s2.ax1x.com/2020/01/16/lvvuqA.png" class="lozad"></p>
<p><strong>步骤五：捕获到有效信号可以开启中断</strong></p>
<p><img alt="捕获到有效信号可以开启中断" data-src="https://s2.ax1x.com/2020/01/16/lvvMVI.md.png" class="lozad"></p>
<h2 id="定时器输入捕获功能常用函数"><a href="#定时器输入捕获功能常用函数" class="headerlink" title="定时器输入捕获功能常用函数"></a>定时器输入捕获功能常用函数</h2><p><strong>①定时器输入捕获时基参数初始化函数：</strong></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HAL_StatusTypeDef <span class="title">HAL_TIM_IC_Init</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> struct</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">uint32_t</span> Prescaler;      <span class="comment">//预分频系数                           </span></span><br><span class="line">  <span class="keyword">uint32_t</span> CounterMode;   <span class="comment">//计数模式：向上/下                       </span></span><br><span class="line">  <span class="keyword">uint32_t</span> Period;     <span class="comment">//自动装载值                               </span></span><br><span class="line">  <span class="keyword">uint32_t</span> ClockDivision;  <span class="comment">//时钟分频因子：定时器时钟与数字滤波器分频比</span></span><br><span class="line">  <span class="keyword">uint32_t</span> RepetitionCounter; <span class="comment">//重复计数次数：高级定时器使用         </span></span><br><span class="line">} TIM_Base_InitTypeDef;</span><br></pre></td></tr></tbody></table></figure>

<p>该函数和HAL_TIM_Base_Init/HAL_TIM_PWM_Init函数作用一样，</p>
<p>不同的是引导调用不同的回调函数。</p>
<p><strong>②定时器输入捕获时基参数初始化回调函数：</strong></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_IC_MspInit</span><span class="params">(TIM_HandleTypeDef *htim)</span></span>;</span><br><span class="line"><span class="comment">/*主要用来编写定时器时钟使能，通道IO配置以及中断优先级设置等。*/</span></span><br><span class="line"></span><br><span class="line">__HAL_RCC_TIM5_CLK_ENABLE();<span class="comment">//定时器3时钟使能</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>③输入捕获通道参数配置函数：</strong></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HAL_StatusTypeDef <span class="title">HAL_TIM_IC_ConfigChannel</span><span class="params">(TIM_HandleTypeDef *htim,TIM_IC_InitTypeDef* sConfig, <span class="keyword">uint32_t</span> Channel)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  <span class="keyword">uint32_t</span>  ICPolarity;     <span class="comment">//捕获极性                     </span></span><br><span class="line">  <span class="keyword">uint32_t</span> ICSelection;  <span class="comment">//输入映射                       </span></span><br><span class="line">  <span class="keyword">uint32_t</span> ICPrescaler;  <span class="comment">//输入分频                       </span></span><br><span class="line">  <span class="keyword">uint32_t</span> ICFilter;         <span class="comment">//输入滤波器                    </span></span><br><span class="line">} TIM_IC_InitTypeDef;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>④使能定时器并使能输入捕获通道：</strong></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HAL_StatusTypeDef <span class="title">HAL_TIM_IC_Start</span> <span class="params">(TIM_HandleTypeDef *htim, <span class="keyword">uint32_t</span> Channel)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">HAL_StatusTypeDef <span class="title">HAL_TIM_IC_Start_IT</span> <span class="params">(TIM_HandleTypeDef *htim, <span class="keyword">uint32_t</span> Channel)</span></span>;<span class="comment">//该函数同时还使能了捕获中断。</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>⑤捕获中断回调函数：</strong></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_IC_CaptureCallback</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>⑥读取捕获值：</strong></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">HAL_TIM_ReadCapturedValue</span><span class="params">(TIM_HandleTypeDef*htim,<span class="keyword">uint32_t</span> Channel)</span></span>;</span><br></pre></td></tr></tbody></table></figure>

<h2 id="输入捕获的一般配置关键步骤"><a href="#输入捕获的一般配置关键步骤" class="headerlink" title="输入捕获的一般配置关键步骤"></a>输入捕获的一般配置关键步骤</h2><p>①使能定时器时钟和通道IO口时钟。</p>
<p>②配置IO口复用映射：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HAL_GPIO_Init();</span><br></pre></td></tr></tbody></table></figure>

<p>③初始化输入捕获时基参数:</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HAL_TIM_IC_Init();</span><br></pre></td></tr></tbody></table></figure>

<p>④初始化输入捕获通道参数：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HAL_TIM_IC_ConfigChannel();</span><br></pre></td></tr></tbody></table></figure>

<p>⑤使能定时器（中断），设置优先级:</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HAL_TIM_IC_Start_IT();</span><br></pre></td></tr></tbody></table></figure>

<p>⑥编写中断服务回调函数：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HAL_TIM_IC_CaptureCallback();</span><br></pre></td></tr></tbody></table></figure>

<h2 id="程序源码-2"><a href="#程序源码-2" class="headerlink" title="程序源码"></a>程序源码</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"timer.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"led.h"</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TIM_HandleTypeDef TIM3_Handler;         <span class="comment">//定时器3PWM句柄 </span></span><br><span class="line">TIM_OC_InitTypeDef TIM3_CH4Handler;	    <span class="comment">//定时器3通道4句柄</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/***************************************************************************</span></span><br><span class="line"><span class="comment">****************************************************************************</span></span><br><span class="line"><span class="comment">  下面是PWM输出实验相关函数源码</span></span><br><span class="line"><span class="comment">****************************************************************************</span></span><br><span class="line"><span class="comment">****************************************************************************/</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//TIM3 PWM部分初始化 </span></span><br><span class="line"><span class="comment">//PWM输出初始化</span></span><br><span class="line"><span class="comment">//arr：自动重装值</span></span><br><span class="line"><span class="comment">//psc：时钟预分频数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM3_PWM_Init</span><span class="params">(u16 arr,u16 psc)</span></span></span><br><span class="line"><span class="function"></span>{ </span><br><span class="line">    TIM3_Handler.Instance=TIM3;            <span class="comment">//定时器3</span></span><br><span class="line">    TIM3_Handler.Init.Prescaler=psc;       <span class="comment">//定时器分频</span></span><br><span class="line">    TIM3_Handler.Init.CounterMode=TIM_COUNTERMODE_UP;<span class="comment">//向上计数模式</span></span><br><span class="line">    TIM3_Handler.Init.Period=arr;          <span class="comment">//自动重装载值</span></span><br><span class="line">    TIM3_Handler.Init.ClockDivision=TIM_CLOCKDIVISION_DIV1;</span><br><span class="line">    HAL_TIM_PWM_Init(&TIM3_Handler);       <span class="comment">//初始化PWM</span></span><br><span class="line">    </span><br><span class="line">    TIM3_CH4Handler.OCMode=TIM_OCMODE_PWM1; <span class="comment">//模式选择PWM1</span></span><br><span class="line">    TIM3_CH4Handler.Pulse=arr/<span class="number">2</span>;            <span class="comment">//设置比较值,此值用来确定占空比，</span></span><br><span class="line">                                            <span class="comment">//默认比较值为自动重装载值的一半,即占空比为50%</span></span><br><span class="line">    TIM3_CH4Handler.OCPolarity=TIM_OCPOLARITY_LOW; <span class="comment">//输出比较极性为低 </span></span><br><span class="line">    HAL_TIM_PWM_ConfigChannel(&TIM3_Handler,&TIM3_CH4Handler,TIM_CHANNEL_4);<span class="comment">//配置TIM3通道4</span></span><br><span class="line">    HAL_TIM_PWM_Start(&TIM3_Handler,TIM_CHANNEL_4);<span class="comment">//开启PWM通道4</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//定时器底层驱动，时钟使能，引脚配置</span></span><br><span class="line"><span class="comment">//此函数会被HAL_TIM_PWM_Init()调用</span></span><br><span class="line"><span class="comment">//htim:定时器句柄</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_PWM_MspInit</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    GPIO_InitTypeDef GPIO_Initure;</span><br><span class="line">		</span><br><span class="line">	__HAL_RCC_TIM3_CLK_ENABLE();			<span class="comment">//使能定时器3</span></span><br><span class="line">    __HAL_RCC_GPIOB_CLK_ENABLE();			<span class="comment">//开启GPIOB时钟</span></span><br><span class="line">	</span><br><span class="line">    GPIO_Initure.Pin=GPIO_PIN_1;           	<span class="comment">//PB1</span></span><br><span class="line">    GPIO_Initure.Mode=GPIO_MODE_AF_PP;  	<span class="comment">//复用推完输出</span></span><br><span class="line">    GPIO_Initure.Pull=GPIO_PULLUP;          <span class="comment">//上拉</span></span><br><span class="line">    GPIO_Initure.Speed=GPIO_SPEED_HIGH;     <span class="comment">//高速</span></span><br><span class="line">	GPIO_Initure.Alternate= GPIO_AF2_TIM3;	<span class="comment">//PB1复用为TIM3_CH4</span></span><br><span class="line">    HAL_GPIO_Init(GPIOB,&GPIO_Initure);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//设置TIM通道4的占空比</span></span><br><span class="line"><span class="comment">//compare:比较值</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM_SetTIM3Compare4</span><span class="params">(u32 compare)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	TIM3->CCR4=compare;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取TIM捕获/比较寄存器值</span></span><br><span class="line"><span class="function">u32 <span class="title">TIM_GetTIM3Capture4</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="keyword">return</span>  HAL_TIM_ReadCapturedValue(&TIM3_Handler,TIM_CHANNEL_4);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/***************************************************************************</span></span><br><span class="line"><span class="comment">****************************************************************************</span></span><br><span class="line"><span class="comment">  下面是输入捕获相关源码实验相关函数源码</span></span><br><span class="line"><span class="comment">****************************************************************************</span></span><br><span class="line"><span class="comment">****************************************************************************/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TIM_HandleTypeDef TIM5_Handler;         <span class="comment">//定时器5句柄</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//定时器5通道1输入捕获配置</span></span><br><span class="line"><span class="comment">//arr：自动重装值(TIM2,TIM5是32位的!!)</span></span><br><span class="line"><span class="comment">//psc：时钟预分频数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM5_CH1_Cap_Init</span><span class="params">(u32 arr,u16 psc)</span></span></span><br><span class="line"><span class="function"></span>{  </span><br><span class="line">    TIM_IC_InitTypeDef TIM5_CH1Config;  </span><br><span class="line">    </span><br><span class="line">    TIM5_Handler.Instance=TIM5;                          <span class="comment">//通用定时器5</span></span><br><span class="line">    TIM5_Handler.Init.Prescaler=psc;                     <span class="comment">//分频系数</span></span><br><span class="line">    TIM5_Handler.Init.CounterMode=TIM_COUNTERMODE_UP;    <span class="comment">//向上计数器</span></span><br><span class="line">    TIM5_Handler.Init.Period=arr;                        <span class="comment">//自动装载值</span></span><br><span class="line">    TIM5_Handler.Init.ClockDivision=TIM_CLOCKDIVISION_DIV1;<span class="comment">//时钟分频银子</span></span><br><span class="line">    HAL_TIM_IC_Init(&TIM5_Handler);<span class="comment">//初始化输入捕获时基参数</span></span><br><span class="line">    </span><br><span class="line">    TIM5_CH1Config.ICPolarity=TIM_ICPOLARITY_RISING;    <span class="comment">//上升沿捕获</span></span><br><span class="line">    TIM5_CH1Config.ICSelection=TIM_ICSELECTION_DIRECTTI;<span class="comment">//映射到TI1上</span></span><br><span class="line">    TIM5_CH1Config.ICPrescaler=TIM_ICPSC_DIV1;          <span class="comment">//配置输入分频，不分频</span></span><br><span class="line">    TIM5_CH1Config.ICFilter=<span class="number">0</span>;                          <span class="comment">//配置输入滤波器，不滤波</span></span><br><span class="line">    HAL_TIM_IC_ConfigChannel(&TIM5_Handler,&TIM5_CH1Config,TIM_CHANNEL_1);<span class="comment">//配置TIM5通道1</span></span><br><span class="line">	</span><br><span class="line">    HAL_TIM_IC_Start_IT(&TIM5_Handler,TIM_CHANNEL_1);   <span class="comment">//开启TIM5的捕获通道1，并且开启捕获中断</span></span><br><span class="line">    __HAL_TIM_ENABLE_IT(&TIM5_Handler,TIM_IT_UPDATE);   <span class="comment">//使能更新中断</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//定时器5底层驱动，时钟使能，引脚配置</span></span><br><span class="line"><span class="comment">//此函数会被HAL_TIM_IC_Init()调用</span></span><br><span class="line"><span class="comment">//htim:定时器5句柄</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_IC_MspInit</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    GPIO_InitTypeDef GPIO_Initure;</span><br><span class="line">    __HAL_RCC_TIM5_CLK_ENABLE();            <span class="comment">//使能TIM5时钟</span></span><br><span class="line">    __HAL_RCC_GPIOA_CLK_ENABLE();			<span class="comment">//开启GPIOA时钟</span></span><br><span class="line">	</span><br><span class="line">    GPIO_Initure.Pin=GPIO_PIN_0;            <span class="comment">//PA0</span></span><br><span class="line">    GPIO_Initure.Mode=GPIO_MODE_AF_PP;      <span class="comment">//复用推挽输出</span></span><br><span class="line">    GPIO_Initure.Pull=GPIO_PULLDOWN;        <span class="comment">//下拉</span></span><br><span class="line">    GPIO_Initure.Speed=GPIO_SPEED_HIGH;     <span class="comment">//高速</span></span><br><span class="line">    GPIO_Initure.Alternate=GPIO_AF2_TIM5;   <span class="comment">//PA0复用为TIM5通道1</span></span><br><span class="line">    HAL_GPIO_Init(GPIOA,&GPIO_Initure);</span><br><span class="line"></span><br><span class="line">    HAL_NVIC_SetPriority(TIM5_IRQn,<span class="number">2</span>,<span class="number">0</span>);    <span class="comment">//设置中断优先级，抢占优先级2，子优先级0</span></span><br><span class="line">    HAL_NVIC_EnableIRQ(TIM5_IRQn);          <span class="comment">//开启ITM5中断通道  </span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//捕获状态</span></span><br><span class="line"><span class="comment">//[7]:0,没有成功的捕获;1,成功捕获到一次.</span></span><br><span class="line"><span class="comment">//[6]:0,还没捕获到低电平;1,已经捕获到低电平了.</span></span><br><span class="line"><span class="comment">//[5:0]:捕获低电平后溢出的次数(对于32位定时器来说,1us计数器加1,溢出时间:4294秒)</span></span><br><span class="line">u8  TIM5CH1_CAPTURE_STA=<span class="number">0</span>;	<span class="comment">//输入捕获状态		    				</span></span><br><span class="line">u32	TIM5CH1_CAPTURE_VAL;	<span class="comment">//输入捕获值(TIM2/TIM5是32位)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//定时器5中断服务函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM5_IRQHandler</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	HAL_TIM_IRQHandler(&TIM5_Handler);<span class="comment">//定时器共用处理函数</span></span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment">//定时器更新中断（计数溢出）中断处理回调函数， 该函数在HAL_TIM_IRQHandler中会被调用</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_PeriodElapsedCallback</span><span class="params">(TIM_HandleTypeDef *htim)</span><span class="comment">//更新中断（溢出）发生时执行</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>((TIM5CH1_CAPTURE_STA&<span class="number">0X80</span>)==<span class="number">0</span>)<span class="comment">//还未成功捕获</span></span><br><span class="line">	{</span><br><span class="line">			<span class="keyword">if</span>(TIM5CH1_CAPTURE_STA&<span class="number">0X40</span>)<span class="comment">//已经捕获到高电平了</span></span><br><span class="line">			{</span><br><span class="line">				<span class="keyword">if</span>((TIM5CH1_CAPTURE_STA&<span class="number">0X3F</span>)==<span class="number">0X3F</span>)<span class="comment">//高电平太长了</span></span><br><span class="line">				{</span><br><span class="line">					TIM5CH1_CAPTURE_STA|=<span class="number">0X80</span>;		<span class="comment">//标记成功捕获了一次</span></span><br><span class="line">					TIM5CH1_CAPTURE_VAL=<span class="number">0XFFFFFFFF</span>;</span><br><span class="line">				}<span class="keyword">else</span> TIM5CH1_CAPTURE_STA++;</span><br><span class="line">			}	 </span><br><span class="line">	}		</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//定时器输入捕获中断处理回调函数，该函数在HAL_TIM_IRQHandler中会被调用</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_IC_CaptureCallback</span><span class="params">(TIM_HandleTypeDef *htim)</span><span class="comment">//捕获中断发生时执行</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="keyword">if</span>((TIM5CH1_CAPTURE_STA&<span class="number">0X80</span>)==<span class="number">0</span>)<span class="comment">//还未成功捕获</span></span><br><span class="line">	{</span><br><span class="line">		<span class="keyword">if</span>(TIM5CH1_CAPTURE_STA&<span class="number">0X40</span>)		<span class="comment">//捕获到一个下降沿 		</span></span><br><span class="line">			{	  			</span><br><span class="line">				TIM5CH1_CAPTURE_STA|=<span class="number">0X80</span>;		<span class="comment">//标记成功捕获到一次高电平脉宽</span></span><br><span class="line">                TIM5CH1_CAPTURE_VAL=HAL_TIM_ReadCapturedValue(&TIM5_Handler,TIM_CHANNEL_1);<span class="comment">//获取当前的捕获值.</span></span><br><span class="line">                TIM_RESET_CAPTUREPOLARITY(&TIM5_Handler,TIM_CHANNEL_1);   <span class="comment">//一定要先清除原来的设置！！</span></span><br><span class="line">                TIM_SET_CAPTUREPOLARITY(&TIM5_Handler,TIM_CHANNEL_1,TIM_ICPOLARITY_RISING);<span class="comment">//配置TIM5通道1上升沿捕获</span></span><br><span class="line">			}<span class="keyword">else</span>  								<span class="comment">//还未开始,第一次捕获上升沿</span></span><br><span class="line">			{</span><br><span class="line">				TIM5CH1_CAPTURE_STA=<span class="number">0</span>;			<span class="comment">//清空</span></span><br><span class="line">				TIM5CH1_CAPTURE_VAL=<span class="number">0</span>;</span><br><span class="line">				TIM5CH1_CAPTURE_STA|=<span class="number">0X40</span>;		<span class="comment">//标记捕获到了上升沿</span></span><br><span class="line">				__HAL_TIM_DISABLE(&TIM5_Handler);        <span class="comment">//关闭定时器5</span></span><br><span class="line">				__HAL_TIM_SET_COUNTER(&TIM5_Handler,<span class="number">0</span>);</span><br><span class="line">				TIM_RESET_CAPTUREPOLARITY(&TIM5_Handler,TIM_CHANNEL_1);   <span class="comment">//一定要先清除原来的设置！！</span></span><br><span class="line">				TIM_SET_CAPTUREPOLARITY(&TIM5_Handler,TIM_CHANNEL_1,TIM_ICPOLARITY_FALLING);<span class="comment">//定时器5通道1设置为下降沿捕获</span></span><br><span class="line">				__HAL_TIM_ENABLE(&TIM5_Handler);<span class="comment">//使能定时器5</span></span><br><span class="line">			}		    </span><br><span class="line">	}		</span><br><span class="line">	</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h1 id="TIMER电容触摸按键原理与实验"><a href="#TIMER电容触摸按键原理与实验" class="headerlink" title="TIMER电容触摸按键原理与实验"></a>TIMER电容触摸按键原理与实验</h1><h2 id="电容触摸按键原理"><a href="#电容触摸按键原理" class="headerlink" title="电容触摸按键原理"></a>电容触摸按键原理</h2><p><strong>结论</strong>：同样的条件下，电容值C跟时间值t成正比关系，电容越大，充电到达某个临界值的时间越长。</p>
<p><img alt="电容触摸按键原理" data-src="https://s2.ax1x.com/2020/01/16/lvvlIP.png" class="lozad"></p>
<p>R:外接电容充放电电阻。</p>
<p>Cs:TPAD和PCB间的杂散电容。</p>
<p>Cx:手指按下时，手指和TPAD之间的电容。</p>
<p>开关：电容放电开关，由STM32 IO口代替。</p>
<p><strong>检测电容触摸按键过程</strong></p>
<p>①TPAD引脚设置为推挽输出，输出0，实现电容放电到0。</p>
<p>②TPAD引脚设置为浮空输入（IO复位后的状态）,电容开始充电。</p>
<p>③同时开启TPAD引脚的输入捕获开始捕获。</p>
<p>④等待充电完成（充电到底Vx,检测到上升沿）。</p>
<p>⑤计算充电时间。</p>
<p><strong>没有按下的时候，充电时间为T1（default)。按下TPAD，电容变大，所以充电时间为T2。我们可以通过检测充放电时间，来判断是否按下。如果T2-T1大于某个值，就可以判断有按键按下。</strong></p>
<h2 id="几个重要的函数"><a href="#几个重要的函数" class="headerlink" title="几个重要的函数"></a>几个重要的函数</h2><p>①<strong>void TPAD_Reset(void)函数：复位TPAD</strong></p>
<p>   设置IO口为推挽输出输出0，电容放电。等待放电完成之后，设置为浮空</p>
<p>​    输入，从而开始充电。同时把计数器的CNT设置为0。</p>
<p><strong>②</strong> <strong>TPAD_Get_Val()函数：获取一次捕获值（得到充电时间）</strong></p>
<p>   复位TPAD,等待捕获上升沿，捕获之后，得到定时器的值，计算充电时间。</p>
<p><strong>③</strong> <strong>TPAD_Get_MaxVal()函数：</strong></p>
<p>   多次调用TPAD_Get_Val函数获取充电时间。获取最大的值。</p>
<p><strong>④ TPAD_Init()函数：初始化TPAD</strong></p>
<p>   在系统启动后，初始化输入捕获。先10次调用TPAD_Get_Val()函数获取</p>
<p>   10次充电时间，然后获取中间N(N=8或者6）次的平均值，作为在没有电容触摸按键按下的时候的充电时间缺省值tpad_default_val。</p>
<p><strong>⑤ TPAD_Scan()函数：扫描TPAD</strong></p>
<p>   调用TPAD_Get_MaxVal函数获取多次充电中最大的充电时间，跟</p>
<p>   tpad_default_val比较，如果大于某个阈值，则认为有触摸动作。</p>
<p><strong>⑥ void TIM2_CH2_Cap_Init(u16 arr,u16 psc//输入捕获通道初始化</strong></p>
<p>  可以使用任何一个定时器。M3使用定时器5，M4使用的定时器2。</p>
<p><strong>程序思路<img alt="程序思路" data-src="https://s2.ax1x.com/2020/01/16/lvvQat.md.png" class="lozad"></strong></p>
<h2 id="程序源码-3"><a href="#程序源码-3" class="headerlink" title="程序源码"></a>程序源码</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"tpad.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"delay.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"usart.h"</span></span></span><br><span class="line"></span><br><span class="line">TIM_HandleTypeDef TIM2_Handler;         <span class="comment">//定时器2句柄 </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TPAD_ARR_MAX_VAL  0XFFFFFFFF	<span class="comment">//最大的ARR值(TIM2是32位定时器)	  </span></span></span><br><span class="line">vu16 tpad_default_val=<span class="number">0</span>;				<span class="comment">//空载的时候(没有手按下),计数器需要的时间</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化触摸按键</span></span><br><span class="line"><span class="comment">//获得空载的时候触摸按键的取值.</span></span><br><span class="line"><span class="comment">//psc:分频系数,越小,灵敏度越高.</span></span><br><span class="line"><span class="comment">//返回值:0,初始化成功;1,初始化失败</span></span><br><span class="line"><span class="function">u8 <span class="title">TPAD_Init</span><span class="params">(u8 psc)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	u16 buf[<span class="number">10</span>];</span><br><span class="line">	u16 temp;</span><br><span class="line">	u8 j,i;</span><br><span class="line">	TIM2_CH1_Cap_Init(TPAD_ARR_MAX_VAL,psc<span class="number">-1</span>);<span class="comment">//设置分频系数</span></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i<<span class="number">10</span>;i++)<span class="comment">//连续读取10次</span></span><br><span class="line">	{				 </span><br><span class="line">		buf[i]=TPAD_Get_Val();</span><br><span class="line">		delay_ms(<span class="number">10</span>);	    </span><br><span class="line">	}				    </span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i<<span class="number">9</span>;i++)<span class="comment">//排序</span></span><br><span class="line">	{</span><br><span class="line">		<span class="keyword">for</span>(j=i+<span class="number">1</span>;j<<span class="number">10</span>;j++)</span><br><span class="line">		{</span><br><span class="line">			<span class="keyword">if</span>(buf[i]>buf[j])<span class="comment">//升序排列</span></span><br><span class="line">			{</span><br><span class="line">				temp=buf[i];</span><br><span class="line">				buf[i]=buf[j];</span><br><span class="line">				buf[j]=temp;</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	temp=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">2</span>;i<<span class="number">8</span>;i++)temp+=buf[i];<span class="comment">//取中间的8个数据进行平均</span></span><br><span class="line">	tpad_default_val=temp/<span class="number">6</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"tpad_default_val:%d\r\n"</span>,tpad_default_val);	</span><br><span class="line">	<span class="keyword">if</span>(tpad_default_val>TPAD_ARR_MAX_VAL/<span class="number">2</span>)<span class="keyword">return</span> <span class="number">1</span>;<span class="comment">//初始化遇到超过TPAD_ARR_MAX_VAL/2的数值,不正常!</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;		     	    					   </span><br><span class="line">}</span><br><span class="line"><span class="comment">//复位一次</span></span><br><span class="line"><span class="comment">//释放电容电量，并清除定时器的计数值</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TPAD_Reset</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    GPIO_InitTypeDef GPIO_Initure;</span><br><span class="line">	</span><br><span class="line">    GPIO_Initure.Pin=GPIO_PIN_5;            <span class="comment">//PA5</span></span><br><span class="line">    GPIO_Initure.Mode=GPIO_MODE_OUTPUT_PP;  <span class="comment">//推挽输出</span></span><br><span class="line">    GPIO_Initure.Pull=GPIO_PULLDOWN;        <span class="comment">//下拉</span></span><br><span class="line">    GPIO_Initure.Speed=GPIO_SPEED_HIGH;     <span class="comment">//高速</span></span><br><span class="line">    HAL_GPIO_Init(GPIOA,&GPIO_Initure);</span><br><span class="line">    </span><br><span class="line">    HAL_GPIO_WritePin(GPIOA,GPIO_PIN_5,GPIO_PIN_RESET);	<span class="comment">//PA5输出0，放电</span></span><br><span class="line">    delay_ms(<span class="number">5</span>);</span><br><span class="line">    __HAL_TIM_CLEAR_FLAG(&TIM2_Handler,TIM_FLAG_CC1|TIM_FLAG_UPDATE);   <span class="comment">//清除标志位</span></span><br><span class="line">    __HAL_TIM_SET_COUNTER(&TIM2_Handler,<span class="number">0</span>); <span class="comment">//计数器值归0</span></span><br><span class="line">    </span><br><span class="line">    GPIO_Initure.Mode=GPIO_MODE_AF_PP;      <span class="comment">//推挽复用</span></span><br><span class="line">    GPIO_Initure.Pull=GPIO_NOPULL;          <span class="comment">//不带上下拉</span></span><br><span class="line">    GPIO_Initure.Alternate=GPIO_AF1_TIM2;   <span class="comment">//PA5复用为TIM2通道1</span></span><br><span class="line">    HAL_GPIO_Init(GPIOA,&GPIO_Initure);         </span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//得到定时器捕获值</span></span><br><span class="line"><span class="comment">//如果超时,则直接返回定时器的计数值.</span></span><br><span class="line"><span class="comment">//返回值：捕获值/计数值（超时的情况下返回）</span></span><br><span class="line"><span class="function">u16 <span class="title">TPAD_Get_Val</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    TPAD_Reset();</span><br><span class="line">    <span class="keyword">while</span>(__HAL_TIM_GET_FLAG(&TIM2_Handler,TIM_FLAG_CC1)==RESET) <span class="comment">//等待捕获上升沿</span></span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span>(__HAL_TIM_GET_COUNTER(&TIM2_Handler)>TPAD_ARR_MAX_VAL<span class="number">-500</span>) <span class="keyword">return</span> __HAL_TIM_GET_COUNTER(&TIM2_Handler);<span class="comment">//超时了，直接返回CNT的值</span></span><br><span class="line">    };</span><br><span class="line">    <span class="keyword">return</span> HAL_TIM_ReadCapturedValue(&TIM2_Handler,TIM_CHANNEL_1);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取n次,取最大值</span></span><br><span class="line"><span class="comment">//n：连续获取的次数</span></span><br><span class="line"><span class="comment">//返回值：n次读数里面读到的最大读数值</span></span><br><span class="line"><span class="function">u16 <span class="title">TPAD_Get_MaxVal</span><span class="params">(u8 n)</span></span></span><br><span class="line"><span class="function"></span>{ </span><br><span class="line">	u16 temp=<span class="number">0</span>; </span><br><span class="line">	u16 res=<span class="number">0</span>; </span><br><span class="line">	u8 lcntnum=n*<span class="number">2</span>/<span class="number">3</span>;<span class="comment">//至少2/3*n的有效个触摸,才算有效</span></span><br><span class="line">	u8 okcnt=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(n--)</span><br><span class="line">	{</span><br><span class="line">		temp=TPAD_Get_Val();<span class="comment">//得到一次值</span></span><br><span class="line">		<span class="keyword">if</span>(temp>(tpad_default_val*<span class="number">5</span>/<span class="number">4</span>))okcnt++;<span class="comment">//至少大于默认值的5/4才算有效</span></span><br><span class="line">		<span class="keyword">if</span>(temp>res)res=temp;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">if</span>(okcnt>=lcntnum)<span class="keyword">return</span> res;<span class="comment">//至少2/3的概率,要大于默认值的5/4才算有效</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}  </span><br><span class="line"></span><br><span class="line"><span class="comment">//扫描触摸按键</span></span><br><span class="line"><span class="comment">//mode:0,不支持连续触发(按下一次必须松开才能按下一次);1,支持连续触发(可以一直按下)</span></span><br><span class="line"><span class="comment">//返回值:0,没有按下;1,有按下;										  </span></span><br><span class="line"><span class="function">u8 <span class="title">TPAD_Scan</span><span class="params">(u8 mode)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="keyword">static</span> u8 keyen=<span class="number">0</span>;	<span class="comment">//0,可以开始检测;>0,还不能开始检测	 </span></span><br><span class="line">	u8 res=<span class="number">0</span>;</span><br><span class="line">	u8 sample=<span class="number">3</span>;	<span class="comment">//默认采样次数为3次	 </span></span><br><span class="line">	u16 rval;</span><br><span class="line">	<span class="keyword">if</span>(mode)</span><br><span class="line">	{</span><br><span class="line">		sample=<span class="number">6</span>;	<span class="comment">//支持连按的时候，设置采样次数为6次</span></span><br><span class="line">		keyen=<span class="number">0</span>;	<span class="comment">//支持连按	  </span></span><br><span class="line">	}</span><br><span class="line">	rval=TPAD_Get_MaxVal(sample); </span><br><span class="line">	<span class="keyword">if</span>(rval>(tpad_default_val*<span class="number">4</span>/<span class="number">3</span>)&&rval<(<span class="number">10</span>*tpad_default_val))<span class="comment">//大于tpad_default_val+(1/3)*tpad_default_val,且小于10倍tpad_default_val,则有效</span></span><br><span class="line">	{							 </span><br><span class="line">		<span class="keyword">if</span>(keyen==<span class="number">0</span>)res=<span class="number">1</span>;	<span class="comment">//keyen==0,有效 </span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"r:%d\r\n"</span>,rval);		     	    					   </span><br><span class="line">		keyen=<span class="number">3</span>;				<span class="comment">//至少要再过3次之后才能按键有效   </span></span><br><span class="line">	} </span><br><span class="line">	<span class="keyword">if</span>(keyen)keyen--;		   							   		     	    					   </span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">}	</span><br><span class="line"></span><br><span class="line"><span class="comment">//定时器2通道1输入捕获配置</span></span><br><span class="line"><span class="comment">//arr：自动重装值(TIM2是32位的!!)</span></span><br><span class="line"><span class="comment">//psc：时钟预分频数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM2_CH1_Cap_Init</span><span class="params">(u32 arr,u16 psc)</span></span></span><br><span class="line"><span class="function"></span>{  </span><br><span class="line">    TIM_IC_InitTypeDef TIM2_CH1Config;  </span><br><span class="line">    </span><br><span class="line">    TIM2_Handler.Instance=TIM2;                          <span class="comment">//通用定时器3</span></span><br><span class="line">    TIM2_Handler.Init.Prescaler=psc;                     <span class="comment">//分频</span></span><br><span class="line">    TIM2_Handler.Init.CounterMode=TIM_COUNTERMODE_UP;    <span class="comment">//向上计数器</span></span><br><span class="line">    TIM2_Handler.Init.Period=arr;                        <span class="comment">//自动装载值</span></span><br><span class="line">    TIM2_Handler.Init.ClockDivision=TIM_CLOCKDIVISION_DIV1;</span><br><span class="line">    HAL_TIM_IC_Init(&TIM2_Handler);</span><br><span class="line">    </span><br><span class="line">    TIM2_CH1Config.ICPolarity=TIM_ICPOLARITY_RISING;    <span class="comment">//上升沿捕获</span></span><br><span class="line">    TIM2_CH1Config.ICSelection=TIM_ICSELECTION_DIRECTTI;<span class="comment">//映射到TI1上</span></span><br><span class="line">    TIM2_CH1Config.ICPrescaler=TIM_ICPSC_DIV1;          <span class="comment">//配置输入分频，不分频</span></span><br><span class="line">    TIM2_CH1Config.ICFilter=<span class="number">0</span>;                          <span class="comment">//配置输入滤波器，不滤波</span></span><br><span class="line">    HAL_TIM_IC_ConfigChannel(&TIM2_Handler,&TIM2_CH1Config,TIM_CHANNEL_1);<span class="comment">//配置TIM2通道1</span></span><br><span class="line">    HAL_TIM_IC_Start(&TIM2_Handler,TIM_CHANNEL_1);      <span class="comment">//开始捕获TIM2的通道1</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//定时器2底层驱动，时钟使能，引脚配置</span></span><br><span class="line"><span class="comment">//此函数会被HAL_TIM_IC_Init()调用</span></span><br><span class="line"><span class="comment">//htim:定时器2句柄</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_IC_MspInit</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    GPIO_InitTypeDef GPIO_Initure;</span><br><span class="line">    __HAL_RCC_TIM2_CLK_ENABLE();            <span class="comment">//使能TIM2时钟</span></span><br><span class="line">    __HAL_RCC_GPIOA_CLK_ENABLE();			<span class="comment">//开启GPIOA时钟</span></span><br><span class="line">	</span><br><span class="line">    GPIO_Initure.Pin=GPIO_PIN_5;            <span class="comment">//PA5</span></span><br><span class="line">    GPIO_Initure.Mode=GPIO_MODE_AF_PP;      <span class="comment">//推挽复用</span></span><br><span class="line">    GPIO_Initure.Pull=GPIO_NOPULL;          <span class="comment">//不带上下拉</span></span><br><span class="line">    GPIO_Initure.Speed=GPIO_SPEED_HIGH;     <span class="comment">//高速</span></span><br><span class="line">    GPIO_Initure.Alternate=GPIO_AF1_TIM2;   <span class="comment">//PA5复用为TIM2通道1</span></span><br><span class="line">    HAL_GPIO_Init(GPIOA,&GPIO_Initure);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">jiangzuojiben</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://jiangzuojiben.github.io/2020/01/16/TIMER%E9%80%9A%E7%94%A8%E5%AE%9A%E6%97%B6%E5%99%A8/">http://jiangzuojiben.github.io/2020/01/16/TIMER%E9%80%9A%E7%94%A8%E5%AE%9A%E6%97%B6%E5%99%A8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://jiangzuojiben.github.io">jiangzuojiben</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/stm32/">stm32    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/2020/08/02/%E5%B0%8F%E6%98%8E%E7%9A%84%E6%AD%BB/"><img class="prev_cover lozad" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>小明的死</span></div></a></div><div class="next-post pull-right"><a href="/2019/11/17/EXTI%E5%A4%96%E9%83%A8%E4%B8%AD%E6%96%AD%E5%92%8C%E7%9C%8B%E9%97%A8%E7%8B%97%E5%AE%9E%E9%AA%8C/"><img class="next_cover lozad" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>EXTI外部中断和看门狗实验</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2019/11/01/SysTick定时器，NVIC中断优先级和IO引脚复用/" title="SysTick定时器，NVIC中断优先级和IO引脚复用"><img class="relatedPosts_cover lozad"data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><div class="relatedPosts_title">SysTick定时器，NVIC中断优先级和IO引脚复用</div></a></div><div class="relatedPosts_item"><a href="/2019/11/17/EXTI外部中断和看门狗实验/" title="EXTI外部中断和看门狗实验"><img class="relatedPosts_cover lozad"data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><div class="relatedPosts_title">EXTI外部中断和看门狗实验</div></a></div><div class="relatedPosts_item"><a href="/2019/11/01/STM32时钟系统/" title="STM32时钟系统"><img class="relatedPosts_cover lozad"data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><div class="relatedPosts_title">STM32时钟系统</div></a></div><div class="relatedPosts_item"><a href="/2019/11/10/UART——串口详解/" title="UART——串口详解"><img class="relatedPosts_cover lozad"data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><div class="relatedPosts_title">UART——串口详解</div></a></div><div class="relatedPosts_item"><a href="/2019/11/01/跑马灯实验和GPIO口按键输入实验/" title="跑马灯实验和GPIO口按键输入实验"><img class="relatedPosts_cover lozad"data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><div class="relatedPosts_title">跑马灯实验和GPIO口按键输入实验</div></a></div></div><div class="clear_both"></div></div></div></div><footer><div id="footer"><div class="copyright">&copy;2019 - 2020 By jiangzuojiben</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://jiangzuojiben.github.io/">blog</a>!</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">简</a><i class="nightshift fa fa-moon-o" id="nightshift" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script src="/js/nightshift.js"></script><script color="0,0,255" opacity="0.7" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN/js/canvas-nest.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script>const observer = lozad(); // lazy loads elements with default selector as '.lozad'
observer.observe();
</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7}});</script></body></html>